# Техническое Задание: AgencyOS

Это сводный документ, описывающий архитектуру и функционал операционной системы для агентства "AgencyOS", основанной на стеке Telegram, n8n, Airtable и GPT.

## 1. Общая Архитектура

Система состоит из четырех слоев:

1.  **Telegram-Бот (Интерфейс):** Единая точка входа для команды с роль-ориентированными клавиатурами.
2.  **n8n (Мозг):** Центральный хаб, который слушает бота, запускает воркфлоу, работает с Airtable и GPT, выполняет задачи по расписанию.
3.  **Airtable (База данных):** "Единый источник правды", хранящий все данные.
4.  **GPT API (AI-модуль):** Используется для обработки неструктурированных данных (анализ скриншотов, классификация текста).

## 2. Структура Базы Данных в Airtable

-   **`[Core] Сотрудники`**:
    -   `Имя`, `Должность`, `Telegram User ID`, `Роль в боте`, `Процент комиссии`, `Фикс. ЗП`.
-   **`[Core] Модели`**:
    -   `Имя/Псевдоним`, `Менеджер` (Link to `Сотрудники`), `Исключить из общих расходов?` (Checkbox).
-   **`[Core] Страницы`**:
    -   `ID Страницы`, `Модель` (Link to `Модели`), `Ссылка`.
-   **`[Finance] Оборот`**:
    -   `Сумма`, `Дата`, `Страница` (Link to `Страницы`), `Платежный Период` (Formula).
-   **`[Finance] Расходы`**:
    -   `Статья`, `Сумма`, `Дата`, `Тип Расхода` (Select), `Связь со Страницей/Сотрудником`, `Платежный Период` (Formula).
-   **`[Finance] Касса Операторов`**:
    -   Таблица, куда операторы вносят данные о продажах. Содержит поля для автоматического расчета их ЗП по формуле.
-   **`[Finance] Stats`**:
    -   Итоговая ежемесячная таблица. Поля: `Месяц` (YYYY-MM), `Модель` (Link), `Общий Оборот`, `Итого Расходов`, `Чистая Прибыль`, `Дельта кассы (1-8)`, `Дельта кассы (16-23)`.
-   **`[PM] Задачи`**:
    -   Основная таблица задач. Поля: `Название`, `Ответственный` (Link to `Сотрудники`), `Дедлайн`, `Статус`, `Связь с Глобальным Процессом`.
-   **`[PM] Шаблоны Задач`**:
    -   Справочник для автоматического создания задач. Поля: `Название задачи`, `Отдел` (Select), `Дней на выполнение`, `Привязка к Глобальному Процессу` (напр. "Онбординг").

### Ключевые Формулы:

-   **Поле `Платежный Период`** (в `Оборот` и `Расходы`):
    ```
    IF(DAY({Дата}) <= 15, DATETIME_FORMAT({Дата}, "YYYY-MM") & " (1-15)", DATETIME_FORMAT({Дата}, "YYYY-MM") & " (16-31)")
    ```

## 3. Логика Автоматизации в n8n

### Воркфлоу 1: "Зарплатный"
-   **Триггер:** Cron (1-го и 16-го числа каждого месяца).
-   **Логика:**
    1.  Определяет платежный период для расчета (1-15 или 16-31).
    2.  Считает и создает записи о расходах на ЗП для:
        -   **Операторов:** на основе данных из `Касса Операторов`.
        -   **Менеджеров:** % от оборота их моделей за период.
        -   **Старшего Менеджера:** % от общего оборота агентства за период.
    3.  Автоматически создает записи в таблице `Расходы`.

### Воркфлоу 2: "Ежемесячный P&L Отчет"
-   **Триггер:** Cron (2-го числа каждого месяца).
-   **Логика:**
    1.  Для каждой **Модели** агрегирует данные за прошлый месяц.
    2.  Суммирует `Оборот` и `Прямые расходы` со всех её **Страниц**.
    3.  Добавляет долю общих расходов и комиссий.
    4.  Рассчитывает "Дельту кассы" за периоды 1-8 и 16-23.
    5.  Создает/обновляет итоговую запись в таблице `Stats`.

### Воркфлоу 3: "Задачи и Процессы"
-   **Триггер:** Webhook от Telegram-бота (команда, например, "/start_onboarding").
-   **Логика:**
    1.  Находит все задачи в `Шаблоны Задач` для данного процесса.
    2.  Создает реальные задачи в таблице `Задачи`, назначая ответственных и дедлайны.

### Воркфлоу 4: "Обработка Скриншотов Оборота"
-   **Триггер:** Webhook от Telegram-бота (получение фото).
-   **Логика:**
    1.  Отправляет скриншот в GPT-4 Vision для извлечения суммы.
    2.  Создает запись в `Оборот` и запись о выплате модели в `Расходы`.

### Прочие Воркфлоу:
-   Ежедневные отчеты по KPI (постинг, прирост фанов).
-   Напоминания о задачах.
-   Управление файлами на Google Drive.

## 4. Уровни Отчетности

1.  **Стратегический (Таблица `Stats`):** Итоговый P&L по **модели** за месяц.
2.  **Операционный (Airtable Interfaces):** Интерактивный дашборд для анализа P&L по каждой отдельной **странице** внутри модели.

## 5. План Внедрения (Roadmap)

1.  **Этап 1 (Фундамент):** Настройка Airtable, базовый бот, модуль "Задачи и Процессы".
2.  **Этап 2 (Финансы):** Разработка "Зарплатного" воркфлоу и интеграция с GPT-Vision.
3.  **Этап 3 (Полная автоматизация):** Все остальные отчеты, управление контентом, дашборды. 